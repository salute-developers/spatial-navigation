<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Spatnav sanity check</title>
        <link rel="stylesheet" href="../../demo/sample/spatnav-style.css">
        <link rel="stylesheet" href="test.css">
        <script src="test.js"></script>
        <script src="../../polyfill/spatial-navigation-polyfill.js"></script>
    </head>
<style>
    .container {
        width:500px;
        height:150px;
    }

    input {
        margin: 0px;
        padding: 0px;
    }

</style>
<body onload="onload()"></body>
<script type="text/javascript">
    var onload = () => {
        const totalTestNum = 7; 
        for (let i=0; i < totalTestNum; i++) {
            let divElm = document.createElement('div');
            divElm.innerHTML = `<div class="container" id="c${i+1}">
                                    <button class="box" id="b1" style="position: relative; top: 10px; left: 120px; height: 30px; width: 80px;"></button>
                                    <div id="inputForm1">
                                        <input id="input1" type="text" placeholder="I'm focusable!" style="position: relative; top: 20px; left: 10px;"/>
                                        <button class="box" id="b2" style="position: relative; top: 24px; left: 20px; height: 20px; width: 40px;"></button>
                                        </div>
                                    <div id="inputForm2">
                                        <input id="input2" type="text" placeholder="I'm focusable!" style="position: relative; top: 40px; left: 10px;"/>
                                        <button class="box" id="b3" style="position: relative; top: 44px; left: 20px; height: 20px; width: 40px;"></button>
                                    </div>
                                </div>`;
            document.body.appendChild(divElm);
        }

        testInit();

        let testNum = 1;
        let containers = document.querySelectorAll('.container');

        testRun(function() {
            containers[0].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[0].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].tabindex = -1;
                if(objs[i].nodeName === 'INPUT') objs[i].placeholder = `I'm non-focusable`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[0].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#input1'));
        }, `Reset the search origin when it became non-focusable TC${testNum++}. Search origin is still the rect of non-focusable element`);

        testRun(function() {
            containers[1].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[0].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].inert = true;
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm inert`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[1].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[1].querySelector('#input1'));
        }, `Reset the search origin when it became inert TC${testNum++}. Search origin is still the rect of inert element`);

        testRun(function() {
            containers[2].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[2].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].disabled = true;
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm disabled`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[2].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[2].querySelector('#input1'));
        }, `Reset the search origin when it became disabled TC${testNum++}. Search origin is still the rect of disabled element`);

        testRun(function() {
            containers[3].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[3].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].style.visibility = 'hidden';
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm 'visibility: hidden'`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[3].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[3].querySelector('#input1'));
        }, `Reset the search origin when it became 'visibility: hidden' TC${testNum++}. Search origin is still the rect of 'visibility: hidden' element`);

        testRun(function() {
            containers[4].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[4].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].style.opacity = '0';
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm 'opacity: 0'`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[4].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[4].querySelector('#input1'));
        }, `Reset the search origin when it became 'opacity: 0' TC${testNum++}. Search origin is still the rect of 'opacity: 0' element`);

        testRun(function() {
            containers[5].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[5].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].style.display = 'none';
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm 'display: none'`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[5].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[5].querySelector('#input1'));
        }, `Reset the search origin when it became 'display: none' TC${testNum++}. Search origin is the previous of 'display: none' element`);

        testRun(function() {
            containers[6].querySelector('#b1').focus();
            window.navigate('down');
            const objs = containers[6].querySelector('#inputForm1').children;
            for (let i = 0; i < objs.length; i++) {
                objs[i].style.width = '0px';
                objs[i].style.height = '0px';
                objs[i].style.fontSize = '0px';
                objs[i].style.border = '0px';
                if(objs[i].nodeName === 'INPUT')    objs[i].placeholder = `I'm zero sized element`;
            }
            window.navigate('down');

            assert_equals(document.activeElement, containers[6].querySelector('#input2'));
            assert_not_equals(document.activeElement, containers[0].querySelector('#b1'));
            assert_not_equals(document.activeElement, containers[6].querySelector('#input1'));
        }, `Reset the search origin when its size became zero TC${testNum++}. Search origin is the previous rect of zero sized element`);
    }
</script>
</html>
